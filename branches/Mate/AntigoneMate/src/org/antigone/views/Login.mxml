<?xml version="1.0" encoding="utf-8"?>
<mx:Panel
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:mate="http://mate.asfusion.com/"
	title="Identification" xmlns:models="org.antigone.models.*">
	
	<mx:Script>
		<![CDATA[
			import mx.validators.Validator;
			import mx.events.ValidationResultEvent; 
	    	import org.antigone.events.*;   	
			
			// mutate the loginBtn's click event into a cairngorm event			
			private function PerformLogin() : void 
			{
				// if everything validates, broadcast an event containing the username & password	
				if (Validator.validateAll(validators).length == 0 )
					loginDispatcher.generateEvent();
			}
			
			private function NewUserCreation() : void
			{
				dispatchEvent(new NavigationEvent(NavigationEvent.NEW_USER));
			}
			
			private function checkLoginResult(result:Boolean):void 
			{
				if (!result) {
					//show invalid login message
					//currentState = 'messageState';
					loginButton.errorString = "Identifiants incorrects ; veuillez rÃ©essayer.";
				}
				else 
				{
					//successful login
					// clear all fields otherwise they'll still be populated whenever the user returns here
					ClearForm();
				}
			}
			
			private function ClearForm():void
			{
				currentState = '';
				username.text ='';
				username.errorString = '';
				password.text = '';
				password.errorString = '';
				
				loginButton.errorString = "";
			}
		]]>
	</mx:Script>
	
	<!-- Dispatchers -->
	<mate:Dispatcher id="loginDispatcher" generator="{UserEvent}" type="{UserEvent.LOGIN}">
		<mate:ResponseHandler type="loginResultResponse" response="checkLoginResult(event.loginResult)" />
		<mate:eventProperties>
			<mate:EventProperties user="{userModel}" />
		</mate:eventProperties>
	</mate:Dispatcher>
	
	<!-- User model, bound to the form fields -->
	<models:User id="userModel" username="{username.text}" password="{password.text}" />

	<!-- UI -->
	<mx:Form id="loginForm" defaultButton="{loginButton}">
		<mx:FormItem label="Identifiant">
			<mx:TextInput id="username" />
		</mx:FormItem>
		<mx:FormItem label="Mot de passe">
			<mx:TextInput id="password" displayAsPassword="true"/>
		</mx:FormItem>
		<mx:HBox horizontalAlign="center" width="100%">		
			<mx:Button label="Nouvel utilisateur" click="NewUserCreation()" />
			<mx:Button id="loginButton" label="S'identifier" click="PerformLogin()" />
		</mx:HBox>
	</mx:Form>
	
	<!-- Validators -->
	<mx:Array id="validators">
		<mx:StringValidator source="{username}" property="text" required="true" />
		<mx:StringValidator source="{password}" property="text" required="true" />
	</mx:Array>
	
	<!-- States -->
	<!-- mx:states>
		<mx:State name="messageState">
			<mx:AddChild relativeTo="{loginForm}" position="before">
				<mx:Text text="Invalid login information, please try again"/>
			</mx:AddChild>
		</mx:State>
	</mx:states -->
	
</mx:Panel>
